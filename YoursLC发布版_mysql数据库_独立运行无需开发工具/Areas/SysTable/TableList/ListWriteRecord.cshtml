@{
    ViewBag.Title = @ViewBag.name;
    Layout = "~/Areas/Shared/_LayuiList.cshtml";
}

<input style="display: none" id="id" value="@ViewBag.id">
<table class="layui-hide" id="tableId" lay-filter="tableFilter"></table>

<script src="~/lib/layui/layui.js" charset="utf-8"></script>
<script>
    layui.use(["table", "form", "exLayer", "exUtils"], function () {
        let table = layui.table;
        let form = layui.form;
        let exLayer = layui.exLayer;
        let exUtils = layui.exUtils;
        let $ = layui.$;

        let ThisTable = table.render({
            elem: "#tableId",
            url: "/SysTable/TbRelation/GetWriteRecordList?id=" + $("#id").val(),
            limits: [10, 50, 100, 200],
            limit: 10,
            page: true,
            defaultToolbar: [{ title: '刷新', layEvent: 'refresh', icon: 'layui-icon-refresh' }, 'exports', 'filter'],
            toolbar: "#toolbarTpl",
            cols: [[
                { type: "checkbox", fixed: 'left' },
                { type: "numbers", title: "NO.", fixed: 'left' },
                { field: "PrcsId", title: "步骤编码", width: 100, sort: true, align: 'center' },
                { field: "FromTbId", title: "源表ID", width: 120, sort: true, align: 'center' },
                { field: "WriteTbId", title: "目标表ID", width: 120, sort: true, align: 'center' },
                { field: "FromId", title: "源ID", width: 90, sort: true, align: 'center' },
                { field: "WriteId", title: "目标ID", width: 90, sort: true, align: 'center' },
                { field: "strSql", title: "strSql", sort: true, align: 'center' },
                { field: "Num", title: "影响行", width: 100, sort: true, align: 'center' },
                { field: "WriteTime", title: "时间", width: 150, sort: true },
                { field: "Err", title: "错误", width: 100, sort: true, templet: "#Err" }
            ]],
            done: function (res, curr, count) {
                //console.log(res, curr, count);
            }
        });

        table.on("toolbar(tableFilter)", function (obj) {
            switch (obj.event) {
                case "refresh":
                    refresh();
                    break;
                case "batchDel"://批量删除按钮事件
                    batchDel();
                    break;
            }
        });

        function batchDel() {
            var idsStr = "";
            var checkStatus = table.checkStatus("tableId");
            var rows = checkStatus.data.length;
            if (rows > 0) {
                for (var i = 0; i < checkStatus.data.length; i++) {
                    idsStr += checkStatus.data[i].ID + ",";
                }
                exLayer.confirm("生产环境下禁止删除记录，因为纪录将作为『只运行一次』条件的判断依据，确定要删除吗？", function (index) {
                    layer.close(index);
                    if (idsStr) {
                        exUtils.ajax("/SysTable/TableList/BatchDelRecord", "post", { idsStr: idsStr, tbid: 'relationwriterecord' }, true).done(function (response) {
                            exUtils.tableSuccessMsg(response.message);
                            $(".layui-laypage-btn")[0].click();
                        }).fail(function (error) {
                            console.log(error);
                        });
                    }
                });
            }
            else {
                layer.msg("未选择有效数据");
            }
        }

        function refresh() {
            ThisTable.reload({
                url: "/SysTable/TbRelation/GetWriteRecordList?id=" + $("#id").val(),
            });
        }
    });
</script>

<script type="text/html" id="toolbarTpl">
    <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="batchDel" id="batchDel"><i class="fa fa-trash-o"></i></button> &nbsp;&nbsp;&nbsp; @ViewBag.name
</script>
<script type="text/html" id="Err">
    {{#  if(d.Err !=  null){ }}
    <span style="color: #FFAB00;">{{d.Err}}</span>
    {{#  } }}
</script>