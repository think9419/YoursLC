@{
    ViewBag.Title = "Assign";
    Layout = "~/Areas/Shared/_LayuiList.cshtml";
}

<style type="text/css">
    .div-collapse {
        float: left;
        height: 18px;
        line-height: 18px;
        padding-left: 5px;
    }

    .layui-table-cell .layui-form-checkbox[lay-skin=primary] {
        top: -1px;
        padding-left: 25px; /* 覆盖layui padding */
    }
</style>
<!--数据表格-->
<table class="layui-hide" id="tableId" lay-filter="tableFilter"></table>
<script src="~/lib/layui/layui.js" charset="utf-8"></script>
<script>
    layui.use(["treeGrid", "form", "exUtils"], function () {
        let treeGrid = layui.treeGrid;
        let form = layui.form;
        let exUtils = layui.exUtils;
        let $ = layui.$;

        treeGrid.render({
            elem: "#tableId",
            url: "/SysBasic/Module/ModuleButtonList?roleId=@ViewBag.RoleId",
            page: false,
            toolbar: "#toolbarTpl",

            cellMinWidth: 100,
            treeId: 'Id',   //树形id字段名称
            treeUpId: 'ParentId',   //树形父id字段名称
            treeShowName: 'FullName',   //以树形式显示的字段
            cols: [[
                { field: "FullName", title: "菜单名称", type: 'checkbox_txt', width: layui.device().mobile ? 300 : null },
                { field: "Icon", title: "图标", width: 80, templet: "#T_Icon" }
            ]]
        });

        //关闭页面
        function CloseWin() {
            /*parent.location.reload(); // 父页面刷新*/
            parent.layer.close(parent.layer.getFrameIndex(window.name));
        }

        //折叠展开
        $("#btnFold").on('click', function () {
            $(".div-collapse.root .layui-tree-head").click();
        });

        //保存设置
        $("#btnSave").on('click', function () {
            var _roleId = @ViewBag.RoleId;
            var cbxs = $(".layui-table").find('tbody input[type="checkbox"]');
            var _list = [];
            cbxs.each(function (index, item) {
                if (item.checked == true) {
                    var _row = { RoleId: 0, ModuleId: 0, ButtonId: 0 };
                    var _name = item.name;//chx_2
                    if (_name.indexOf('cbx_') > -1) {
                        _name = _name.replace('cbx_', '');
                    } else {
                        _name = item.getAttribute('tag');
                        if (_name.indexOf('cbx_') > -1) {
                            _name = _name.replace('cbx_', '');
                        }
                    }
                    _row.RoleId = _roleId;
                    _row.ModuleId = _name;
                    _row.ButtonId = 0;
                    _list.push(_row);
                }
            });
            exUtils.ajax("/SysBasic/RoleAuthorize/InsertBatch", "post", { "list": _list, roleId: _roleId }, true).done(function (response) {
                exUtils.tableSuccessMsg(response.message);
                //没开启分页，没确定按钮，手动刷新
                setTimeout(CloseWin, 1500);
            }).fail(function (error) {
                console.log(error);
            });
        });

        treeGrid.on("tool(tableFilter)", function (obj) {
            let data = obj.data;
            if (obj.event === 'selectAll') {  //全选
                $("input[name='cbx_" + data.Id + "']").prop("checked", true);
            } else if (obj.event === 'cancleSelectAll') {//反选
                $("input[name='cbx_" + data.Id + "']").prop("checked", false);
            }
            form.render('checkbox');
        });
    })
</script>
<script type="text/html" id="T_Icon">
    {{#  if(d.Icon == ''){ }}
    <span><i class="fa fa-circle-thin"></i></span>
    {{#  } else{ }}
    <span><i class="fa {{d.Icon}}"></i></span>
    {{#  } }}
</script>
<!-- 头工具栏模板 -->
<script type="text/html" id="toolbarTpl">
    <button class='layui-btn layui-btn-sm layui-btn-normal' id='btnFold'>折叠/展开</button>
    <button class='layui-btn layui-btn-sm layui-btn-warm' id='btnSave'>保存设置</button>
</script>
<!-- 行工具栏模板 -->
<script type="text/html" id="operationTpl">
    {{# if(d.ModuleButtonHtml!=""){}}
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="selectAll">全选</a>
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="cancleSelectAll">反选</a>
    {{# } }}
</script>