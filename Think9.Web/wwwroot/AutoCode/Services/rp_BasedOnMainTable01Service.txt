/*******************************************************************************
 * Creator:admin 2024-09-24 13:35:17
 * Description: Think9企业级开发工具 http://yourslc.top Service类
*********************************************************************************/

using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using Newtonsoft.Json.Linq;
using Think9.Models;
using Think9.Services.Base;
using Think9.Services.Basic;
using Think9.Services.Com;

namespace Think9.Services.CodeBuild
{
    /// <summary>
    /// Service
    /// </summary>
    public partial class BasedOnMainTable01Service : BaseService<BasedOnMainTable01Model>
    {
        private string sql;
        private string str;
        private string itemStr;
        private readonly string _split = Think9.Services.Base.BaseConfig.ComSplit;//多选项的字符分割
        private ComService comService = new ComService();
        private ExtraDbService extraDb = new ExtraDbService();//外部数据源
		private ExtraDbEntity extraDbModel;//外部数据源

        #region sql 自定义的统计指标解析为sql语句

        #endregion sql 自定义的统计指标解析为sql语句

        /// <summary>
        /// 获取分页数据并处理Value与Text转化
        /// </summary>
        /// <param name="total">结果集总数</param>
        /// <param name="controlList">查询条件</param>
        /// <param name="pageInfo">页面信息，包括行数、排序等</param>
        /// <param name="user">当前用户信息</param>
        /// <returns></returns>
        public List<dynamic> GetListForPage(ref long total, IEnumerable<ControlEntity> controlList, PageInfoEntity pageInfo, CurrentUserEntity user)
        {
            //获取分页数据
            List<dynamic> list = GetList(ref total, controlList, pageInfo).ToList();
            GetStatsIndex(list);//获取统计指标值
            //获取下拉选择、多选、单选数据源
            IEnumerable<valueTextEntity> selectList = GetSelectList("list", BasicHelp.GetParamObject(user));
            TransformList(selectList, list, user);//处理Value与Text转化

            return list;
        }

        /// <summary>
        /// 获取分页数据
        /// </summary>
        /// <param name="total">结果集总数</param>
        /// <param name="list">查询条件</param>
        /// <param name="pageInfo">页面信息，包括行数、排序等</param>
        /// <returns></returns>
        private IEnumerable<dynamic> GetList(ref long total, IEnumerable<ControlEntity> list, PageInfoEntity pageInfo)
        {
			string order = " ORDER BY tb_ProductManagement.inCoding";
			string where = GetSearchWhere(list);
			var model = GetParamSearch(list);
			
			return base.GetPageList(ref total, pageInfo, " * ", "tb_ProductManagement", where, order, model);
        }

        /// <summary>
        /// 获取数据
        /// </summary>
        /// <param name="list">查询条件</param>
        /// <param name="user">当前用户信息</param>
        /// <returns></returns>
        private IEnumerable<dynamic> GetList(IEnumerable<ControlEntity> list, CurrentUserEntity user = null)
        {
			string where = GetSearchWhere(list);
			string order = "  ORDER BY tb_ProductManagement.inCoding";
			var model = GetParamSearch(list);
			return base.GetBySql("SELECT * FROM tb_ProductManagement " + where + order, model);
        }

        /// <summary>
        /// 获取数据DataTable导出excel
        /// </summary>
        /// <param name="ControlList">查询条件</param>
        /// <param name="user">当前用户信息</param>
        /// <returns></returns>
        private DataTable GetDataTableForExport(IEnumerable<ControlEntity> ControlList, CurrentUserEntity user = null)
        {
            List<dynamic> list = GetList(ControlList, user).ToList();
            if (list == null || list.Count < 1)
            {
                list.Add(new BasedOnMainTable01Model());//无数据时需加入一条空数据，否则报错
            }
            GetStatsIndex(list);//获取统计指标值
            //获取下拉选择、多选、单选数据源
            IEnumerable<valueTextEntity> selectList = GetSelectList("list", BasicHelp.GetParamObject(user));
            TransformList(selectList, list, user);//处理Value与Text转化

            return DataTableHelp.ListToDataTable<dynamic>(list);//转换DataTable
        }

        /// <summary>
        /// 获取统计指标值
        /// </summary>
        /// <param name="list">数据列表</param>
        /// <param name="user">当前用户</param>
        private void GetStatsIndex(List<dynamic> list, CurrentUserEntity user = null)
        {
			//无统计指标
        }

        /// <summary>
        /// 处理Value与Text转化
        /// </summary>
        /// <param name="SelectList">Value与Text数据列表</param>
        /// <param name="list">数据列表</param>
        /// <param name="user">当前用户</param>
        private void TransformList(IEnumerable<valueTextEntity> SelectList, List<dynamic> list, CurrentUserEntity user = null)
        {
            foreach (BasedOnMainTable01Model obj in list)
            {

				//类别
				foreach (valueTextEntity sel in SelectList.Where(x => x.ClassID == "inCategory"))
				{
					if (obj.inCategory == sel.Value)
					{
						obj.inCategory = sel.Text;
						break;
					}
				}
				//单位
				foreach (valueTextEntity sel in SelectList.Where(x => x.ClassID == "inUnit"))
				{
					if (obj.inUnit == sel.Value)
					{
						obj.inUnit = sel.Text;
						break;
					}
				}
            }
        }

        /// <summary>
        /// 获取rdlc报表的相关数据
        /// </summary>
        /// <param name="rpid">统计表编码</param>
        /// <param name="rpname">统计表名称</param>
        /// <param name="prm">条件参数对象</param>
        /// <returns></returns>
        public RdlcDeviceEntity GetRdlcDevice(string rpid, string rpname, IEnumerable<ControlEntity> controlList)
        {
            string err = "";
            string directory = Directory.GetCurrentDirectory();
            RdlcDeviceEntity device = new RdlcDeviceEntity();

            device.PathRdlc = Path.Combine(directory, "wwwroot\\Reports\\rp_BasedOnMainTable01.rdlc");//rdlc模板文件
            device.PathUserImg = Think9.Services.Base.BaseConfig.GetUserImgPath();//用户图片所在文件夹
            device.ImgNoExist = Think9.Services.Base.BaseConfig.GetImgNoExistPath();//图片不存在时的替代
            //device.MainDt = GetMainDataTable(rpid, rpname);//报表名称
            device.GridDt = GetDataTableForExport(controlList);//列表数据

            return device;
        }

		/// <summary>
		/// 获取下拉选择、多选、单选数据源
		/// 处理列表显示时value与text转化，动态数据源来源于为指标指定的数据规范
		/// </summary>
		/// <param name="from">add、edit或list，list表明从列表页面查询条件跳转而来</param>
		/// <param name="param">条件参数</param>
		/// <returns></returns>
		public IEnumerable<valueTextEntity> GetSelectList(string from, object param)
		{
			DataTable dt = DataTableHelp.NewValueTextDt();

			//类别
			sql = "SELECT inCoding AS id,inName AS name FROM tb_HPLB ORDER BY state";
			foreach (DataRow dr in comService.GetDataTable(sql, param).Rows)
			{
				DataRow row = dt.NewRow();
				row["ClassID"] = "inCategory";
				row["Value"] = dr["id"].ToString();
				row["Text"] = dr["name"].ToString();
				dt.Rows.Add(row);
			}
			//单位
			sql = "SELECT inCoding AS id,inName AS name FROM tb_JLDW ORDER BY state";
			foreach (DataRow dr in comService.GetDataTable(sql, param).Rows)
			{
				DataRow row = dt.NewRow();
				row["ClassID"] = "inUnit";
				row["Value"] = dr["id"].ToString();
				row["Text"] = dr["name"].ToString();
				dt.Rows.Add(row);
			}

			return DataTableHelp.ToEnumerable<valueTextEntity>(dt);//DataTable转换为IEnumerable
		}

        /// <summary>
        /// 获取查询字符串
        /// </summary>
        /// <param name="list">查询条件list</param>
        /// <returns>返回查询字符串</returns>
        private string GetSearchWhere(IEnumerable<ControlEntity> list)
		{
			string where = " WHERE (1 = 1)";
			
			//类别
			str = BasicHelp.GetValueFrmList(list, "inCategory").Trim();
			if (!string.IsNullOrEmpty(str))
			{
				where += " AND (inCategory = @inCategory)"; 
			}
			
			//名称
			str = BasicHelp.GetValueFrmList(list, "inName").Trim();
			if (!string.IsNullOrEmpty(str))
			{
				where += " AND (inName LIKE  @inName)"; 
			}
			
			//单位
			str = BasicHelp.GetValueFrmList(list, "inUnit").Trim();
			if (!string.IsNullOrEmpty(str))
			{
				where += " AND (inUnit = @inUnit)"; 
			}
			
			//单价
			str = BasicHelp.GetValueFrmList(list, "inUnitPrice").Trim();
			if (!string.IsNullOrEmpty(str))
			{
				where += " AND (inUnitPrice >= @inUnitPrice)"; 
			}
			str = BasicHelp.GetValueFrmList(list, "inUnitPrice_Exa").Trim();
			if (!string.IsNullOrEmpty(str))
			{
				where += " AND (inUnitPrice <= @inUnitPrice_Exa)"; 
			}
			return where;
		}

        /// <summary>
        /// 查询条件list转化为Model
        /// </summary>
        /// <param name="list">查询条件list</param>
        /// <returns></returns>
        private BasedOnMainTable01Model GetParamSearch(IEnumerable<ControlEntity> list)
		{
			
			string _inCategory = BasicHelp.GetValueFrmList(list, "inCategory").Trim();//类别
			string _inName = BasicHelp.GetValueFrmList(list, "inName").Trim();//名称
			string _inUnit = BasicHelp.GetValueFrmList(list, "inUnit").Trim();//单位
			string _inUnitPrice = BasicHelp.GetValueFrmList(list, "inUnitPrice").Trim();//单价
			string _inUnitPrice_Exa = BasicHelp.GetValueFrmList(list, "inUnitPrice_Exa").Trim();//单价
			return new BasedOnMainTable01Model{ inCategory = _inCategory, inName = string.Format("%{0}%", _inName), inUnit = _inUnit, inUnitPrice = ExtConvert.ToDecimalOrNull(_inUnitPrice), inUnitPrice_Exa = ExtConvert.ToDecimalOrNull(_inUnitPrice_Exa) };
		}

        /// <summary>
        /// 获取对象并向查询条件赋初始值
        /// </summary>
        /// <param name="request">request不为空时（通常为从其他页面打开）</param>
        /// <returns></returns>
        public BasedOnMainTable01Model GetModel(Microsoft.AspNetCore.Http.HttpRequest request)
        {
            BasedOnMainTable01Model model = new BasedOnMainTable01Model();
            if (request != null)
            {
				if (!string.IsNullOrEmpty(request.Query["inCategory"]))
				{
					model.inCategory = request.Query["inCategory"].ToString();//类别
				}
				if (!string.IsNullOrEmpty(request.Query["inCategory_Exa"]))
				{
					model.inCategory_Exa = request.Query["inCategory_Exa"].ToString();//类别
				}
				if (!string.IsNullOrEmpty(request.Query["inName"]))
				{
					model.inName = request.Query["inName"].ToString();//名称
				}
				if (!string.IsNullOrEmpty(request.Query["inUnit"]))
				{
					model.inUnit = request.Query["inUnit"].ToString();//单位
				}
				if (!string.IsNullOrEmpty(request.Query["inUnit_Exa"]))
				{
					model.inUnit_Exa = request.Query["inUnit_Exa"].ToString();//单位
				}
				if (!string.IsNullOrEmpty(request.Query["inUnitPrice"]) && ValidatorHelper.IsNumberic(request.Query["inUnitPrice"].ToString()))
				{
					model.inUnitPrice = ExtConvert.ToDecimalOrNull(request.Query["inUnitPrice"].ToString());//单价
				}
				if (!string.IsNullOrEmpty(request.Query["inUnitPrice_Exa"]) && ValidatorHelper.IsNumberic(request.Query["inUnitPrice_Exa"].ToString()))
				{
					model.inUnitPrice_Exa = ExtConvert.ToDecimalOrNull(request.Query["inUnitPrice_Exa"].ToString());//单价
				}
            }
            return model;
        }

        /// <summary>
        /// 获取数据
        /// </summary>
        /// <param name="rpid">统计表编码</param>
        /// <param name="rpname">统计表名称</param>
        /// <returns></returns>
        private DataTable GetMainDataTable(string rpid, string rpname)
        {
            DataTable dt = DataTableHelp.NewReportMainTb();
            DataRow row = dt.NewRow();
            row["ReportID"] = rpid;
            row["ReportName"] = rpname;
            row["ReportParm"] = "";
            row["Title"] = rpname;
            dt.Rows.Add(row);

            return dt;
        }
    }
}